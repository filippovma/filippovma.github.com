<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Mikhail Filippov's Blog]]></title>
  <link href="http://blog.filippov.me/atom.xml" rel="self"/>
  <link href="http://blog.filippov.me/"/>
  <updated>2013-01-28T10:52:28+04:00</updated>
  <id>http://blog.filippov.me/</id>
  <author>
    <name><![CDATA[Mikhail Filippov]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Обзор облака из коробки.]]></title>
    <link href="http://blog.filippov.me/blog/2013/01/26/review-infobox-cloud/"/>
    <updated>2013-01-26T00:15:00+04:00</updated>
    <id>http://blog.filippov.me/blog/2013/01/26/review-infobox-cloud</id>
    <content type="html"><![CDATA[<p>Последние несколько месяцев проходило тестирование облака от компании InfoBox. Хотелось бы поделится впечатлениями о данном решение.</p>

<p>Облако InfoBox построено на основе контейнерной виртуализации от компании Parallels. Есть возможность выбора контейнера как на основе Linux так и на основе Windows. В качестве Linux дистрибутива предлагается Debian 6.0 x86_64. В качестве Windows: Server 2008 R2.</p>

<p>Интерфейс управления облаком InfoBox выглядит достаточно не плохо и в целом позволяет быстро разобраться с ним даже не подготовленному пользователю. При создании машин есть 3 предопределенных профиля: Basic, Power и Mega. Вот пример настроек доступных при создании виртуальной машины:
<img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/1.png" alt="Создание виртуальной машины" />
Есть одна интересная особенность не забудьте выбрать пропускную способность. Шейпер у инфобокс работает очень хорошо, я сначала не понял почему так сильно тормозит сеть. Особенно это сильно заметно на RDP соединение у Windows машины. Эту настройку можно поменять после того как машины будет создана.</p>

<p>В работе с сетью есть несколько особенностей. Во первых у клиента есть возможность использовать как публичные так и приватные адреса. То есть вы можете создать приватную сетевую  инфраструктуру и сделать себе 1 точку входа в нее. Во вторых можно создать один или несколько преднастроенных балансировщиков нагрузки HTTP, которые можно сразу назначить на уже созданные сервера. Еще одно особенностью является то что исходящий траффик платный. Для тестирования производительности сети я установил на сервер SpeedTest Mini. Вот результат теста при том что в настройках сетевого подключения стоит ограничение 100 КБит/сек:</p>

<p><img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/2.png" alt="Тест сети 100КБит/сек" /></p>

<p>А вот при ограничение в 50МБит/сек:</p>

<p><img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/3.png" alt="Тест сети 50МБит/сек" /></p>

<p>Как видим полоса пропускания соответствует заявленной.
Из веб-интерфейса так же можно управлять настройками брандмауэра:
<img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/4.png" alt="Создание правила брандмауэра" />
Чтобы оценить примерные затраты на использование облака, по каждому серверу можно просмотреть расход ресурсов и примерную стоимость:
<img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/5.png" alt="Расход ресурсов" />
Так же можно помотреть расход ресурсов по всей инфраструктуре в пункте &#8220;Использование всех ресурсов&#8221;:
<img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/6.png" alt="Использование всех ресурсов" />
На учетной записи есть общие лимиты которые действуют суммарно на всю инфраструктуру их можно просмотреть в пункте меню &#8220;Ресурсы подписки&#8221;:
<img src="http://blog.filippov.me/images/2013-01-26-review-infobox-cloud/7.png" alt="Ресурсы подписки" />
Из веб-панели всегда можно сбросить пароль для доступа к машине при этом новый пароль Вам вышлют на почту на которую зарегистрирован аккаунт.</p>

<p>Отдельно хочется отметить достаточно удобный функционал резервного копирования машин по расписанию &#8220;Ежедневно&#8221; и &#8220;Еженедельно&#8221;. Из минусов не нашел как выгрузить резервные копии на свой внешний ресурс и нет возможности восстановить резервную копию в отдельную машину, чтобы была возможность достать срез данных на определенный момент.
Доступна функциональность создания образа сервера, который в дальнейшем можно использовать как шаблон для запуска новых серверов, очень удобная вещь для массового развертывания приложений.</p>

<p>Для автоматизации облака доступен API <a href="http://download.pa.parallels.com/poa/5.4/doc/pdf/POA%20RESTful%20API%20Guide/paci-restful-api-guide-5.4.pdf">PACI</a> с помощью удобного REST интерфейса вы можете написать различные скрипты автоматизации работы облака.</p>

<p>Из общих моментов InfoBox так же предлагает дополнтельный услуги такие как управление и регистрация доменов и SSL-сертификаты.
По итогам тестирования особых проблем с работой облака я не заметил. Иногда были некоторые подтормаживания веб-интерфейса управления, но в целом все работает не плохо. Еще из минусов не нашел возможности делегирования управления на дополнительные учетные записи например если у вас в компании несколько системных администраторов и вы бы хотели делегировать управление частью сервером им, все работает под одной учетной записью, но я думаю при производственном внедрении InfoBox сможет решить эту проблемы. Отдельно хотелось бы заметить наличие контейнеров с Windows Server, я их пробывал в первый раз, оказалось вполне достойное решение.</p>

<p>Вы можете сами все это потрогать достаточно пройти по адресу <a href="http://www.infobox.ru/cloud/servers/">http://www.infobox.ru/cloud/servers/</a> и заказать себе тестовый доступ, там же вы можете получить дополнительную информацию и задать свои вопросы онлайн-консультанту.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Тестирование с помощью Microsoft Fakes]]></title>
    <link href="http://blog.filippov.me/blog/2012/07/08/unit-testing-with-microsoft-fakes/"/>
    <updated>2012-07-08T10:39:00+04:00</updated>
    <id>http://blog.filippov.me/blog/2012/07/08/unit-testing-with-microsoft-fakes</id>
    <content type="html"><![CDATA[<p>В Visual Studio 2012 получил развитие один из продуктов Microsoft Researсh известный под именем Moles. Это mock-фреймворк для облегчения написания юнит-тестов. Моки это специальные объекты заглушки, с помощью которых в реализуют части функциональности приложения, которые необходимы тестируемому методу. Это дает возможность тестировать только логику метода определив статическую логику для его зависимостей.</p>

<p>В .NET существует популярный mock-фреймвок: <a href="http://code.google.com/p/moq/">Moq</a>, но он не позволяет мокировать статические методы. Это является достаточно серьезной проблемой, когда вы тестируете код который зависит к примеру от текущей даты или файловой системы. Проблема заключается в следующем. Предположим у Вас есть код который регистрирует время входа пользователя в систему:</p>

<figure class='code'><figcaption><span>AccountManager.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountManager</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_logs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">SignIn</span><span class="p">(</span><span class="kt">string</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_logs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="s">&quot;{0} {1} Sign In&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span> <span class="n">user</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetLogs</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_logs</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Напишем тест на метод SignIn:</p>

<figure class='code'><figcaption><span>AccountManagerTests.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[TestClass]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountManagerTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [TestMethod]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldBeCorrectLogRecordAfterSignIn</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">mgr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AccountManager</span><span class="p">();</span>
</span><span class='line'>        <span class="n">mgr</span><span class="p">.</span><span class="n">SignIn</span><span class="p">(</span><span class="s">&quot;user1&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;02/03/2001 01:02:03 user1 SignIn&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="p">.</span><span class="n">GetLogs</span><span class="p">().</span><span class="n">Last</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Здесь мы сталкиваемся с проблемой тест не проходит потому, что в коде функции используется статическое свойство DateTime.Now, которое всегда выдает текущую дату и время и нет способа указать ей что надо возвращать какое-то предопределенное значение.</p>

<p>До появления Fakes можно было поступить так. Сделать хелпер класс который бы отвечал за обертывание вызова DateTime.Now и передать его в конструктор объекта.</p>

<p>Рассмотрим какие возможности предоставляет нам Microsoft Fakes. В Fakes существует два способа мокирования объектов: Stub и Shim. Они имееют разную реализацию и используются для решения различных типов задач.</p>

<ol>
<li><p>Stubs предназначены для мокирования интерфейсов и виртуальных методов не sealed классов. Эту функциональность предоставляют и другие тестовые фреймворки и работает достаточно быстро, потому что основанна на наследовании.</p></li>
<li><p>Shims предназначены для мокирования статических, не переопределяемых методов, а также встроенных системных типов. Эта функциональность уникальна для Fakes и позволяет избежать создания множества оберток для сокрытия системных типов. Shims основаны на перезаписи кода в рантайме, и работают достаточно медленно. Давайте посмотрим как использовать обе эти технологии.</p></li>
</ol>


<p>Для начала рассмотрим Stubs. Продолжим предыдущий пример. Для выноса из класса AccountManager зависимости DateTime, создадим новый интерфейс IDateTime, который будет определять 1 метод Now(), возвращающий текущую дату и время:</p>

<figure class='code'><figcaption><span>IDateTime.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IDateTime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">DateTime</span> <span class="nf">Now</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Добавим в основной проект его реализацию:</p>

<figure class='code'><figcaption><span>DateTimeHelper.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DateTimeHelper</span> <span class="p">:</span> <span class="n">IDateTime</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">DateTime</span> <span class="nf">Now</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Изменим AccountManager так, чтобы он принимал реализацию интерфейса в конструкторе и использовал её для получения текущего времени:</p>

<figure class='code'><figcaption><span>AccountManager.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountManager</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDateTime</span> <span class="n">_dateTime</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_logs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">AccountManager</span><span class="p">(</span><span class="n">IDateTime</span> <span class="n">dateTime</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_dateTime</span> <span class="p">=</span> <span class="n">dateTime</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">SignIn</span><span class="p">(</span><span class="kt">string</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_logs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="s">&quot;{0} {1} Sign In&quot;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">_dateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">(),</span> <span class="n">user</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetLogs</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_logs</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Теперь перепишем тест с использованием Stubs, для этого для начала нужно сгенерировать Stubs. Нажмем правой кнопкой на сборку к которой мы хотим получить Stub. И выберем: Add Fakes Assembly.</p>

<p><img src="http://blog.filippov.me/images/2012-08-07-unit-testing-with-microsoft-fakes/img1.png" alt="How to generate Stubs." /></p>

<p>После этого у нас появятся сгенерированные Stubs для всех классов сборки. И файл с расширением .fakes с настройками кодогенерации. Теперь в тесте мы можем использовать сгенерированный Stub.</p>

<figure class='code'><figcaption><span>AccountManagerTests.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[TestClass]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountManagerTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [TestMethod]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldBeCorrectLogRecordAfterSignIn</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">stub</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StubIDateTime</span> <span class="p">{</span> <span class="n">Now</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2001</span><span class="p">,</span> <span class="m">02</span><span class="p">,</span> <span class="m">03</span><span class="p">,</span> <span class="m">01</span><span class="p">,</span> <span class="m">02</span><span class="p">,</span> <span class="m">03</span><span class="p">,</span> <span class="n">DateTimeKind</span><span class="p">.</span><span class="n">Local</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">mgr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AccountManager</span><span class="p">(</span><span class="n">stub</span><span class="p">);</span>
</span><span class='line'>        <span class="n">mgr</span><span class="p">.</span><span class="n">SignIn</span><span class="p">(</span><span class="s">&quot;user1&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;02/03/2001 01:02:03 user1 Sign In&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="p">.</span><span class="n">GetLogs</span><span class="p">().</span><span class="n">Last</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Запустим тест и видим что он нормально проходит.
Stub так же можно использовать для мокирования свойств:</p>

<figure class='code'><figcaption><span>test.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">interface</span> <span class="n">IMyInterface</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">stub</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StubIMyInterface</span><span class="p">();</span>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span><span class='line'><span class="n">stub</span><span class="p">.</span><span class="n">ValueGet</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="n">stub</span><span class="p">.</span><span class="n">ValueSet</span> <span class="p">=</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Дополнительную информацию о Stubs можно получить в <a href="http://msdn.microsoft.com/en-us/library/hh549174%28v=vs.110%29.aspx">MSDN</a>.</p>

<p>Теперь рассмотрим Shims. В тестовом проекте интерфейс IDateTime служит исключительно для того чтобы была возможность подменить вызов DateTime.Now, давайте посмотрим как с этим справится Shim. Для начала удалим интерфейс и его реализацию, затем вернем на место вызов DateTime.Now.</p>

<figure class='code'><figcaption><span>AccountManager.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountManager</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_logs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">SignIn</span><span class="p">(</span><span class="kt">string</span> <span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_logs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>                                 <span class="s">&quot;{0} {1} Sign In&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">,</span> <span class="n">user</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetLogs</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_logs</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> Видим что тест перестал проходить. Теперь добавим в тест изменение поведения DateTime.Now с помощью Shims. Для начала сделаем Add Fakes Assembly для сборки System, это обеспечит генерацию Shim для класса DateTime, а за тем перепишем код теста:</p>

<figure class='code'><figcaption><span>AccountManagerTests.cs</span><a href='http://blog.filippov.me/blog/2012/08/07/unit-testing-with-microsoft-fakes/'>Ссылка на статью</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[TestMethod]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldBeCorrectLogRecordAfterSignIn</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="n">ShimsContext</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ShimDateTime</span><span class="p">.</span><span class="n">NowGet</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">DateTime</span><span class="p">(</span><span class="m">2001</span><span class="p">,</span> <span class="m">02</span><span class="p">,</span> <span class="m">03</span><span class="p">,</span> <span class="m">01</span><span class="p">,</span> <span class="m">02</span><span class="p">,</span> <span class="m">03</span><span class="p">,</span>
</span><span class='line'><span class="n">DateTimeKind</span><span class="p">.</span><span class="n">Local</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">mgr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AccountManager</span><span class="p">();</span>
</span><span class='line'>        <span class="n">mgr</span><span class="p">.</span><span class="n">SignIn</span><span class="p">(</span><span class="s">&quot;user1&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;02/03/2001 01:02:03 user1 Sign In&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="p">.</span><span class="n">GetLogs</span><span class="p">().</span><span class="n">Last</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Запустим тест и видим, что он проходит. Shim позволяет подменять функциональность любых закрытых методов и избавляет нас от необходимости делать кучу ненужных оберток. Опишу подробнее, что происходит. Все вызовы к DateTime.Now внутри блока using (ShimsContext.Create()) будут перехвачены и подменены mock-объектом. Mock-контекст существует только в рамках этого блока. Дополнительно об использование Shims вы можете почитать в <a href="http://msdn.microsoft.com/en-us/library/hh549176%28v=vs.110%29.aspx">MSDN</a>.</p>

<p>Подведем итоги Microsoft Fakes представляет собой Mock-фреймворк интегрированный в Visual Studio 2012 и позволяющий сильно упростить написание тестов на платформе .NET.</p>

<p>P.S. Если кому-то интересны какие-то особенности Fakes пишите комментарии постораюсь ответить.</p>
]]></content>
  </entry>
  
</feed>
